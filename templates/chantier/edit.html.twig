{% extends 'base.html.twig' %}

{% block title %}Modifier le Chantier{% endblock %}

{% block body %}
<div class="container mt-5">
    <h1 class="mb-4">Modifier le chantier - {{ chantier.ville }}</h1>

    {{ form_start(form, {'attr': {'class': 'chantier-form'}}) }}

    {# Section Client #}
 <div class="poste-section_ClCh">
    <div class="poste-header">
        <h4 class="mb-0">
            <i class="bi bi-person-fill"></i> Informations du client
        </h4>
    </div>

    <div class="etapes-grid">
        <div class="etape-field">
            {{ form_label(form.client.nom, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.client.nom, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.client.nom) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.client.prenom, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.client.prenom, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.client.prenom) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.client.telephone, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.client.telephone, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.client.telephone) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.client.mail, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.client.mail, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.client.mail) }}
            </div>
        </div>
    </div>
 </div>

    {# Section Chantier #}
<div class="poste-section_ClCh">
    <div class="poste-header">
        <h4 class="mb-0">
            <i class="bi bi-building"></i> Informations du chantier
        </h4>
    </div>

    <div class="etapes-grid">

        <div class="etape-field">
            {{ form_label(form.adresse, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.adresse, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.adresse) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.copos, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.copos, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.copos) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.ville, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.ville, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.ville) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.datePrevue, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.datePrevue, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.datePrevue) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.dateDemarrage, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.dateDemarrage, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.dateDemarrage) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.dateFin, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.dateFin, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.dateFin) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.dateReception, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.dateReception, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.dateReception) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.distanceDepot, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.distanceDepot, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.distanceDepot) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.tempsTrajet, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.tempsTrajet, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.tempsTrajet) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.surfacePlancher, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.surfacePlancher, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.surfacePlancher) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.surfaceHabitable, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.surfaceHabitable, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.surfaceHabitable) }}
            </div>
        </div>
        <div class="etape-field">
            {{ form_label(form.statut, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.statut, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.statut) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.equipe, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.equipe, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.equipe) }}
            </div>
        </div>
        <div class="etape-field etape-field-full">
            {{ form_label(form.alerte, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.alerte) }}
                {{ form_errors(form.alerte) }}
            </div>
        </div>

    </div>
</div>

    {# Section Postes et Étapes #}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h3 class="mb-0"><i class="bi bi-check2-square"></i> Postes et étapes</h3>
        </div>
        <div class="card-body">
            {% for poste in postes %}
                <div class="poste-section mb-4">
                    {# En-tête du poste avec montants HT et TTC #}
                    <div class="poste-header">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0">
                                <i class="bi bi-folder"></i> {{ poste.libelle }}
                            </h4>
                           <div class="montant-field">
                                {{ form_label(form['poste_' ~ poste.id ~ '_montantHT']) }}
                                {{ form_widget(
                                form['poste_' ~ poste.id ~ '_montantHT'],
                                {
                                    'attr': {
                                        'class': 'form-control montant-ht',
                                        'data-poste-id': poste.id,
                                        'data-tva': poste.tva ?? 0
                                    }
                                }
                            ) }}

                            </div>

                            <div class="montant-field">
                                {{ form_label(form['poste_' ~ poste.id ~ '_montantTTC']) }}
                                {{ form_widget(
                                    form['poste_' ~ poste.id ~ '_montantTTC'],
                                    {
                                        'attr': {
                                            'class': 'form-control montant-ttc',
                                            'data-poste-id': poste.id,
                                            'readonly': true
                                        }
                                    }
                                ) }}
                            </div>
                            {% if poste.equipe == 1 %}
                                {% set fieldNbJours = 'poste_' ~ poste.id ~ '_nbJoursMo' %}
                                {% if form[fieldNbJours] is defined %}
                                    <div class="montant-field">
                                        {{ form_label(form[fieldNbJours], 'Nb jours MO') }}
                                        {{ form_widget(form[fieldNbJours]) }}
                                        {{ form_errors(form[fieldNbJours]) }}
                                    </div>
                                {% endif %}
                           {% endif %}
                                                {% if poste.presta == 1 %}
                            {% set fieldNomPresta = 'poste_' ~ poste.id ~ '_nomPrestataire' %}
                            {% set fieldMontantPresta = 'poste_' ~ poste.id ~ '_montantPrestataire' %}

                            {% if form[fieldNomPresta] is defined %}
                                <div class="montant-field">
                                    {{ form_label(form[fieldNomPresta], 'Prestataire') }}
                                    {{ form_widget(form[fieldNomPresta]) }}
                                    {{ form_errors(form[fieldNomPresta]) }}
                                </div>
                            {% endif %}

                            {% if form[fieldMontantPresta] is defined %}
                                <div class="montant-field">
                                    {{ form_label(form[fieldMontantPresta], 'Montant prestataire') }}
                                    {{ form_widget(form[fieldMontantPresta]) }}
                                    {{ form_errors(form[fieldMontantPresta]) }}
                                </div>
                            {% endif %}
                        {% endif %}

                        </div>
                    </div>
                 
                    {# Étapes du poste #}
                    <div class="etapes-grid">
                        {% for etape in poste.etapes %}
                            {% if etape.archive == 0 %}
                                {% set fieldName = 'etape_' ~ etape.id %}
                                {% if form[fieldName] is defined %}
                                    <div class="etape-field">
                                        <label class="etape-label">{{ etape.libelle }}</label>
                                        <div class="etape-input">
                                            {% set etapeFormat = etape.etapeFormat %}

                                            {# Format 1: Oui/Non - Radio buttons #}
                                            {% if etapeFormat and etapeFormat.id == 1 %}
                                                {{ form_widget(form[fieldName]) }}

                                            {# Format 2: Date #}
                                            {% elseif etapeFormat and etapeFormat.id == 2 %}
                                                {{ form_widget(form[fieldName], {'attr': {'class': 'form-control'}}) }}

                                            {# Format 3: Date et heure #}
                                            {% elseif etapeFormat and etapeFormat.id == 3 %}
                                                {{ form_widget(form[fieldName], {'attr': {'class': 'form-control'}}) }}

                                            {# Format 4: Texte #}
                                            {% elseif etapeFormat and etapeFormat.id == 4 %}
                                                {{ form_widget(form[fieldName], {'attr': {'class': 'form-control'}}) }}

                                            {# Par défaut: texte #}
                                            {% else %}
                                                {{ form_widget(form[fieldName], {'attr': {'class': 'form-control'}}) }}
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="d-flex justify-content-between">
        <a href="{{ path('app_chantier_show', {'id': chantier.id}) }}" class="btn btn-secondary btn-lg">
            <i class="bi bi-arrow-left"></i> Annuler
        </a>
        <button type="submit" class="btn btn-warning btn-lg">
            <i class="bi bi-save"></i> Enregistrer les modifications
        </button>
    </div>

    {{ form_end(form) }}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    document.querySelectorAll('.montant-ht').forEach(inputHT => {

        const calculerTTC = () => {
            const posteId = inputHT.dataset.posteId;
            const tvaBrute = parseFloat(inputHT.dataset.tva) || 0;
            const tauxTVA = tvaBrute / 100;

            const inputTTC = document.querySelector(
                '.montant-ttc[data-poste-id="' + posteId + '"]'
            );

            if (!inputTTC) return;

            const ht = parseFloat(inputHT.value.replace(',', '.'));

            if (!isNaN(ht)) {
                const ttc = ht * (1 + tauxTVA);
                inputTTC.value = ttc.toFixed(2);
            } else {
                inputTTC.value = '';
            }
        };

        // Quand on quitte le champ
        inputHT.addEventListener('blur', calculerTTC);

        // Quand la valeur est validée
        inputHT.addEventListener('change', calculerTTC);
    });

});
    // Gérer l'affichage conditionnel du formulaire nouveau client
    document.addEventListener('DOMContentLoaded', function() {
        const clientSelect = document.querySelector('select[name*="[client]"]');
        const nouveauClientSection = document.querySelector('.nouveau-client-section');

        if (clientSelect && nouveauClientSection) {
            function toggleNouveauClient() {
                if (clientSelect.value) {
                    nouveauClientSection.style.opacity = '0.5';
                    nouveauClientSection.querySelectorAll('input').forEach(input => {
                        input.disabled = true;
                    });
                } else {
                    nouveauClientSection.style.opacity = '1';
                    nouveauClientSection.querySelectorAll('input').forEach(input => {
                        input.disabled = false;
                    });
                }
            }

            clientSelect.addEventListener('change', toggleNouveauClient);
            toggleNouveauClient();
        }
    });
</script>
{% endblock %}
