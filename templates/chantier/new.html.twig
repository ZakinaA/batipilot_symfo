{% extends 'base.html.twig' %}

{% block title %}Nouveau Chantier{% endblock %}

{% block body %}
<div class="container mt-5">
    <h1 class="mb-4">Créer un nouveau chantier</h1>

    {{ form_start(form, {'attr': {'class': 'chantier-form'}}) }}

    {# Section Client #}
<div class="poste-section mb-4">
    <div class="poste-header">
        <h4 class="mb-0">
            <i class="bi bi-person-fill"></i> Informations du client
        </h4>
    </div>

    <div class="etapes-grid">
        <div class="etape-field">
            {{ form_label(form.client.nom, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.client.nom, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.client.nom) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.client.prenom, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.client.prenom, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.client.prenom) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.client.telephone, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.client.telephone, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.client.telephone) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.client.mail, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.client.mail, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.client.mail) }}
            </div>
        </div>
    </div>
</div>


    {# Section Chantier #}
<div class="poste-section mb-4">
    <div class="poste-header">
        <h4 class="mb-0">
            <i class="bi bi-building"></i> Informations du chantier
        </h4>
    </div>

    <div class="etapes-grid">

        <div class="etape-field">
            {{ form_label(form.adresse, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.adresse, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.adresse) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.copos, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.copos, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.copos) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.ville, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.ville, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.ville) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.datePrevue, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.datePrevue, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.datePrevue) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.dateDemarrage, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.dateDemarrage, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.dateDemarrage) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.dateFin, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.dateFin, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.dateFin) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.dateReception, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.dateReception, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.dateReception) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.distanceDepot, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.distanceDepot, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.distanceDepot) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.tempsTrajet, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.tempsTrajet, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.tempsTrajet) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.surfaceMaison, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.surfaceMaison, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.surfaceMaison) }}
            </div>
        </div>

        <div class="etape-field">
            {{ form_label(form.surfaceCombles, null, {'label_attr': {'class': 'etape-label'}}) }}
            <div class="etape-input">
                {{ form_widget(form.surfaceCombles, {'attr': {'class': 'form-control'}}) }}
                {{ form_errors(form.surfaceCombles) }}
            </div>
        </div>

    </div>
</div>



    {# Section Postes et Étapes #}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h3 class="mb-0"><i class="bi bi-check2-square"></i> Postes et étapes</h3>
        </div>
        <div class="card-body">
            {% for poste in postes %}
                <div class="poste-section mb-4">
                    {# En-tête du poste avec montants HT et TTC #}
                    <div class="poste-header">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0">
                                <i class="bi bi-folder"></i> {{ poste.libelle }}
                            </h4>
                            <div class="poste-montants d-flex gap-3">
                                <div class="montant-field">
                                    {{ form_label(form['poste_' ~ poste.id ~ '_montantHT']) }}
                                    {{ form_widget(form['poste_' ~ poste.id ~ '_montantHT']) }}
                                </div>
                                <div class="montant-field">
                                    {{ form_label(form['poste_' ~ poste.id ~ '_montantTTC']) }}
                                    {{ form_widget(form['poste_' ~ poste.id ~ '_montantTTC']) }}
                                </div>
                            </div>
                        </div>
                    </div>
                 
                    {# Étapes du poste #}
                    <div class="etapes-grid">
                        {% for etape in poste.etapes %}
                            {% if etape.archive == 0 %}
                                {% set fieldName = 'etape_' ~ etape.id %}
                                {% if form[fieldName] is defined %}
                                    <div class="etape-field">
                                        <label class="etape-label">{{ etape.libelle }}</label>
                                        <div class="etape-input">
                                            {% set etapeFormat = etape.etapeFormat %}

                                            {# Format 1: Oui/Non/Sans objet - Radio buttons #}
                                            {% if etapeFormat and etapeFormat.id == 1 %}
                                                {{ form_widget(form[fieldName]) }}

                                            {# Format 2: Date #}
                                            {% elseif etapeFormat and etapeFormat.id == 2 %}
                                                {{ form_widget(form[fieldName], {'attr': {'class': 'form-control'}}) }}

                                            {# Format 3: Date et heure #}
                                            {% elseif etapeFormat and etapeFormat.id == 3 %}
                                                {{ form_widget(form[fieldName], {'attr': {'class': 'form-control'}}) }}

                                            {# Format 4: Texte #}
                                            {% elseif etapeFormat and etapeFormat.id == 4 %}
                                                {{ form_widget(form[fieldName], {'attr': {'class': 'form-control'}}) }}

                                            {# Par défaut: texte #}
                                            {% else %}
                                                {{ form_widget(form[fieldName], {'attr': {'class': 'form-control'}}) }}
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    {# Boutons d'action #}
    <div class="d-flex justify-content-between mb-5">
        <a href="{{ path('app_chantier_index') }}" class="btn btn-secondary btn-lg">
            <i class="bi bi-arrow-left"></i> Annuler
        </a>
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-save"></i> Créer le chantier
        </button>
    </div>

    {# Ne pas afficher les champs restants automatiquement #}
    {{ form_widget(form._token) }}
    {{ form_end(form, {'render_rest': false}) }}
</div>

<style>
    /* Styles de base */
    .card {
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
    }

    .card-header {
        border-bottom: none;
        padding: 1rem 1.5rem;
        border-radius: 8px 8px 0 0;
    }

    .card-header h3 {
        font-size: 1.25rem;
        margin: 0;
    }

    .card-header i {
        margin-right: 8px;
    }

    .card-body {
        padding: 1.5rem;
    }

    /* Section poste */
    .poste-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #28a745;
    }

    .poste-header h4 {
        color: #28a745;
        font-weight: 600;
        font-size: 1.2rem;
    }

    .poste-header {
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 15px;
        margin-bottom: 20px;
    }

    /* Montants HT et TTC */
    .poste-montants {
        display: flex;
        align-items: center;
    }

    .montant-field {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .montant-field label {
        margin: 0;
        font-weight: 600;
        color: #495057;
        white-space: nowrap;
        font-size: 0.9rem;
    }

    .montant-field input {
        width: 130px;
        padding: 0.4rem 0.6rem;
        font-size: 0.9rem;
    }

    /* Grille des étapes */
    .etapes-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }

    .etape-field {
        background-color: white;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
    }

    .etape-field:hover {
        border-color: #28a745;
        box-shadow: 0 2px 4px rgba(40,167,69,0.1);
    }

    .etape-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }

    .etape-input {
        flex: 1;
    }

    /* Radio buttons pour Oui/Non/Sans objet */
    .etape-input .form-check {
        display: inline-block;
        margin-right: 15px;
        margin-bottom: 5px;
    }

    .form-check-input {
        cursor: pointer;
        margin-top: 0.2rem;
    }

    .form-check-label {
        cursor: pointer;
        margin-left: 0.35rem;
        font-size: 0.9rem;
        color: #6c757d;
    }

    .form-check-input:checked + .form-check-label {
        color: #28a745;
        font-weight: 500;
    }

    /* Champs de formulaire */
    .form-control {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    /* Boutons */
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
        border-radius: 0.375rem;
        font-weight: 500;
    }

    .btn i {
        margin-right: 6px;
    }

    /* Espacement */
    .g-3 {
        --bs-gutter-x: 1rem;
        --bs-gutter-y: 1rem;
    }

    .gap-3 {
        gap: 1rem !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .etapes-grid {
            grid-template-columns: 1fr;
        }

        .poste-header .d-flex {
            flex-direction: column !important;
            align-items: flex-start !important;
        }

        .poste-montants {
            margin-top: 15px;
            width: 100%;
        }

        .montant-field {
            flex: 1;
        }

        .montant-field input {
            width: 100%;
        }
    }
</style>
{% endblock %}
