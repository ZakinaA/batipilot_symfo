{% extends 'base.html.twig' %}

{% block title %}Chantier – {{ chantier.ville }}{% endblock %}

{% block body %}
<div class="container">

    {# ================= HEADER ================= #}
    <div class="header-fiche">
        <h1>Chantier : {{ chantier.ville }}</h1>

        <div>
            <a href="{{ path('app_chantier_edit', {'id': chantier.id}) }}" class="btn-back">
                Modifier
            </a>
            <a href="{{ path('app_chantier_index') }}" class="btn-back">
                ← Retour
            </a>
        </div>
    </div>

    {# ================= FLASH ================= #}
    {% for message in app.flashes('success') %}
        <div class="card" style="border-top-color: var(--success); margin-bottom: 20px;">
            {{ message }}
        </div>
    {% endfor %}

    {# ================= INFOS ================= #}
    <div class="grid-info">

        <div class="card">
            <h2>Client</h2>
            {% if chantier.client %}
                <div class="info-row-grid">
                    <div class="info-col">
                        <span class="label">Nom</span>
                        <span class="value">{{ chantier.client.nom }}</span>
                    </div>
                    <div class="info-col">
                        <span class="label">Prénom</span>
                        <span class="value">{{ chantier.client.prenom ?? '-' }}</span>
                    </div>
                </div>

                <div class="info-row-grid">
                    <div class="info-col">
                        <span class="label">Téléphone</span>
                        <span class="value">{{ chantier.client.telephone ?? '-' }}</span>
                    </div>
                    <div class="info-col">
                        <span class="label">Email</span>
                        <span class="value">{{ chantier.client.mail ?? '-' }}</span>
                    </div>
                </div>
            {% else %}
                <small>Aucun client associé</small>
            {% endif %}
        </div>

        <div class="card">
            <h2>Chantier</h2>

            <div class="info-row-grid">
                <div class="info-col">
                    <span class="label">Adresse</span>
                    <span class="value">{{ chantier.adresse ?? '-' }}</span>
                </div>
                <div class="info-col">
                    <span class="label">Ville</span>
                    <span class="value">{{ chantier.ville }}</span>
                </div>
            </div>

            <div class="info-row-grid">
                <div class="info-col">
                    <span class="label">Code postal</span>
                    <span class="value">{{ chantier.copos ?? '-' }}</span>
                </div>
                <div class="info-col">
                    <span class="label">Surface maison</span>
                    <span class="value">{{ chantier.surfaceMaison ? chantier.surfaceMaison ~ ' m²' : '-' }}</span>
                </div>
            </div>

            <div class="info-row-grid">
                <div class="info-col">
                    <span class="label">Date démarrage</span>
                    <span class="value">{{ chantier.dateDemarrage ? chantier.dateDemarrage|date('d/m/Y') : '-' }}</span>
                </div>
                <div class="info-col">
                    <span class="label">Date fin</span>
                    <span class="value">{{ chantier.dateFin ? chantier.dateFin|date('d/m/Y') : '-' }}</span>
                </div>
            </div>
        </div>
    </div>

    {# ================= POSTES ================= #}
    <h2 style="margin-bottom: 15px;">Postes & étapes</h2>

    {% for poste in postes %}
        {% set cp = chantierPostesIndexed[poste.id] ?? null %}

        <details class="poste-{{ poste.slug ?? 'tech' }}">
            <summary>
                <a class="project-item" href="{{ path('app_poste_show', {'id': poste.id}) }}">
                    <span>{{ poste.libelle }}</span>

                    {% if cp %}
                        {% set tva = poste.tva ?? 0 %}
                        {% set tauxTVA = tva / 100 %}
                        {% set montantHT = cp.montantTTC / (1 + tauxTVA) %}

                        <span class="ttc-label">
                            {{ cp.montantTTC|number_format(2, ',', ' ') }} € TTC
                            <small style="opacity:.7">
                                ({{ montantHT|number_format(2, ',', ' ') }} € HT
                                {% if tva %}- TVA {{ tva }} %{% endif %})
                            </small>
                        </span>
                    {% else %}
                        <span class="ttc-label" style="opacity:.5">
                            — € TTC
                        </span>
                    {% endif %}
                </a>
            </summary>
        </details>
    {% else %}
        <small>Aucun poste défini</small>
    {% endfor %}

    {# ================= SUPPRESSION ================= #}
    <form method="post"
          action="{{ path('app_chantier_delete', {'id': chantier.id}) }}"
          onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce chantier ?');"
          style="margin-top: 30px;">
        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ chantier.id) }}">
        <button class="btn-back" style="border-color: var(--danger); color: var(--danger);">
            Supprimer le chantier
        </button>
    </form>

</div>
{% endblock %}
