{% extends 'base.html.twig' %}

{% block title %}Chantier – {{ chantier.ville }}{% endblock %}

{% block body %}
<div class="container">

    {# ================= HEADER ================= #}
    <div class="header-fiche">
        <h1>Chantier : {{ chantier.ville }}</h1>
        <span>
         Équipe :
            <strong>
                {{ chantier.equipe ? chantier.equipe.nom : '—' }}
            </strong>
        </span>


        <div>
            <a href="{{ path('app_chantier_edit', {'id': chantier.id}) }}" class="btn-back">
                Modifier
            </a>
            <a href="{{ path('app_chantier_index') }}" class="btn-back">
                ← Retour
            </a>
        </div>
    </div>

    {# ================= FLASH ================= #}
    {% for message in app.flashes('success') %}
        <div class="card" data-random-border style="border-top-color: var(--success); margin-bottom: 20px;">
            {{ message }}
        </div>
    {% endfor %}

    {# ================= INFOS ================= #}
    <div class="grid-info">

        <div class="card" data-random-border>
            <h2>Client</h2>
            {% if chantier.client %}
                <div class="info-row-grid">
                    <div class="info-col">
                        <span class="label">Nom</span>
                        <span class="value">{{ chantier.client.nom }}</span>
                    </div>
                    <div class="info-col">
                        <span class="label">Prénom</span>
                        <span class="value">{{ chantier.client.prenom ?? '-' }}</span>
                    </div>
                </div>

                <div class="info-row-grid">
                    <div class="info-col">
                        <span class="label">Téléphone</span>
                        <span class="value">{{ chantier.client.telephone ?? '-' }}</span>
                    </div>
                    <div class="info-col">
                        <span class="label">Email</span>
                        <span class="value">{{ chantier.client.mail ?? '-' }}</span>
                    </div>
                </div>
            {% else %}
                <small>Aucun client associé</small>
            {% endif %}
        </div>

        <div class="card" data-random-border>
            <h2>Chantier</h2>

            <div class="info-row-grid">
                <div class="info-col">
                    <span class="label">Adresse</span>
                    <span class="value">{{ chantier.adresse ?? '-' }}</span>
                </div>
                <div class="info-col">
                    <span class="label">Ville</span>
                    <span class="value">{{ chantier.ville }}</span>
                </div>
            </div>

            <div class="info-row-grid">
                <div class="info-col">
                    <span class="label">Code postal</span>
                    <span class="value">{{ chantier.copos ?? '-' }}</span>
                </div>
                <div class="info-col">
                    <span class="label">Surface plancher</span>
                    <span class="value">{{ chantier.surfacePlancher ? chantier.surfacePlancher ~ ' m²' : '-' }}</span>
                </div>
            </div>

            <div class="info-row-grid">
                <div class="info-col">
                    <span class="label">Date démarrage</span>
                    <span class="value">{{ chantier.dateDemarrage ? chantier.dateDemarrage|date('d/m/Y') : '-' }}</span>
                </div>
                <div class="info-col">
                    <span class="label">Date fin</span>
                    <span class="value">{{ chantier.dateFin ? chantier.dateFin|date('d/m/Y') : '-' }}</span>
                </div>
            </div>
            {% if chantier.alerte %}
    <div class="info-row-grid">
        <div class="info-col" style="grid-column: 1 / -1;">
            <span class="label">
                <i class="bi bi-exclamation-triangle-fill" style="color: #d97706;"></i>
                Alerte
            </span>
            <span class="value">
                {{ chantier.alerte|nl2br }}
            </span>
        </div>
    </div>
{% endif %}

        </div>
    </div>
        {# ================= POSTE ================= #}
                    {% for poste in postes %}
                {% set cp = chantierPostesIndexed[poste.id] ?? null %}

                <details class="poste-{{ poste.slug ?? 'tech' }} poste-details" data-random-border>
                    <summary class="poste-summary">

            <div class="poste-left">
                <span class="toggle-arrow" data-toggle>▶</span>
                <span class="poste-name">{{ poste.libelle }}</span>
            </div>

            <a class="project-item poste-link"
            href="{{ path('app_poste_show', {'id': poste.id}) }}">

                {% if cp %}
                    {% set tva = poste.tva ?? 0 %}
                    {% set tauxTVA = tva / 100 %}
                    {% set montantHT = cp.montantTTC / (1 + tauxTVA) %}

                    <span class="ttc-label">
                        {{ cp.montantTTC|number_format(2, ',', ' ') }} € TTC
                        <small style="opacity:.7">
                            ({{ montantHT|number_format(2, ',', ' ') }} € HT
                            {% if tva %}- TVA {{ tva }} %{% endif %})
                        </small>
                    </span>
                {% else %}
                    <span class="ttc-label" style="opacity:.5">
                        — € TTC
                    </span>
                {% endif %}
            </a>

        </summary>


            {# ===== ETAPES ===== #}
            {% set isPreChantier = poste.libelle == 'Pré-chantier' %}
            <div class="etapes-grid">
                {% if not isPreChantier %}
                    <span>
                        Montant des fournitures :
                        <strong>
                        
                        </strong>
                    </span>
                {% endif %}

                {% if poste.equipe == 1 %}
                    <span>
                        Nombre de jours travaillés :
                        <strong>
                            {{ cp and cp.nbJoursMo is not null ? cp.nbJoursMo : '-' }}
                        </strong>
                    </span>
                {% elseif poste.presta == 1 %}
                    {% if poste.presta == 1 and not isPreChantier %}
                        <span>
                            Prestataire :
                            <strong>
                                {{ cp and cp.nomPrestataire ? cp.nomPrestataire : '-' }}
                            </strong>
                        </span>

                        <span>
                            Montant prestataire :
                            <strong>
                                {{ cp and cp.montantPrestataire
                                    ? cp.montantPrestataire|number_format(2, ',', ' ') ~ ' €'
                                    : '-' }}
                            </strong>
                        </span>
                    {% endif %}
                {% endif %}
                        
                {% for etape in poste.etapes %}
                    {% if etape.archive == 0 %}
                        {% set ce = chantierEtapesIndexed[etape.id] ?? null %}

                        <a class="etape-field"
                        href="{{ path('app_etape_show', {'id': etape.id}) }}">

                            <span class="etape-label">{{ etape.libelle }}</span>

                            {% if ce %}
                                <div class="etape-values" style="margin-top:4px; font-size:.85em; opacity:.85;">
                                    
                                    {% if ce.valText %}
                                        <div> {{ ce.valText }}</div>
                                    {% endif %}

                                    {% if ce.valDate %}
                                        <div> {{ ce.valDate|date('d/m/Y') }}</div>
                                    {% endif %}

                                    {% if ce.valDateHeure %}
                                        <div> {{ ce.valDateHeure|date('d/m/Y H:i') }}</div>
                                    {% endif %}

                                    {% if ce.valBoolean is not null %}
                                        <div>
                                            {{ ce.valBoolean ? ' Oui' : ' Non' }}
                                        </div>
                                    {% endif %}

                                    {% if ce.dateDecimal is not null %}
                                        <div> {{ ce.dateDecimal }}</div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div style="font-size:.8em; opacity:.5;">
                                    Futur information en rapport avec l'etape
                                </div>
                            {% endif %}
                        </a>
                    {% endif %}
                {% endfor %}

            </div>
        </details>
    {% endfor %}


    {# ================= SUPPRESSION ================= #}
    <form method="post"
          action="{{ path('app_chantier_delete', {'id': chantier.id}) }}"
          onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce chantier ?');"
          style="margin-top: 30px;">
        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ chantier.id) }}">
        <button class="btn-back" style="border-color: var(--danger); color: var(--danger);">
            Supprimer le chantier
        </button>
    </form>

</div>
{% endblock %}
